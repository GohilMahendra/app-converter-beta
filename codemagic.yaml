# Check out https://docs.codemagic.io/getting-started/building-a-react-native-app/ for more information
# Please review and update values in curly braces

workflows:
    react-native:
        name: React Native App new
        environment:
            vars:
                XCODE_WORKSPACE: "appconverter"
                XCODE_SCHEME: "appconverter"
                
            node: latest
            xcode: latest
            cocoapods: default
         
        scripts:
        
          
            - curl $(jq -r ".splash" build_data/data.json) > splash.jpg
            - curl $(jq -r ".offline" build_data/data.json) > offline.jpg
            - curl $(jq -r ".logo" build_data/data.json) > ic_launcher.png
            
            - for i in $(seq 0 $(jq -r '.permissions|length-1' build_data/data.json));
                 do sed -i "" -e $'4 a\\\n'" <uses-permission android:name=\"android.permission.$(jq -r ".permissions[$i]" build_data/data.json)\" />" android/app/src/main/AndroidManifest.xml;
                 done
            - cat android/app/src/main/AndroidManifest.xml
            - for i in $(seq 0 $(jq -r ".permissions_IOS|length-1" build_data/data.json));
                do sed -i "" -e $'39 a\\\n'"<key>$(jq -r ".permissions_IOS[$i]" build_data/data.json)</key> " ios/appconverter/info.plist;sed -i "" -e $'40 a\\\n'"<string>permission required for$(jq -r ".permissions_IOS[$i]" build_data/data.json)</string> " ios/appconverter/info.plist;
                done
                 
            - cat ios/appconverter/info.plist
            - if [[ $(jq -r .rate_url build_data/data.json) != "" ]] ; then
              #rating added
              sed -i "" -e $'2 a\\\n'"import Rate from \"react-native-rate\";" screens/HomeScreen.js
              cat screens/HomeScreen.js
              jq -r ."dependencies" += {"react-native-rate":"^1.2.6"}
              fi

             
            
            - sed -i "" "s/<string>1.0</string\>/<string\>\"$(jq -r '.build_version_android' build_data/data.json)\"</string>/g" ios/appconverter/info.plist
            - cat ios/appconverter/info.plist
            - sed -i "" "s/versionName \"1.0\"/versionName \"$(jq -r '.build_version_android' build_data/data.json)\"/g" android/app/build.gradle
            - cat android/app/build.gradle
            - sed -i "" "s/appconverter/$(jq -r '.appname' build_data/data.json)/g" android/app/src/main/res/values/strings.xml
            - sed -i "" "s/appconverter/$(jq -r '.appname' build_data/data.json)/g" android/app/src/main/res/values/strings.xml
            - cat android/app/src/main/res/values/strings.xml
            - sed -i "" "s/appconverter/$(jq -r '.appname' build_data/data.json)/g" ios/appconverter/info.plist
            - cat ios/appconverter/info.plist
            
            - cp ic_launcher.png android/app/src/main/res/drawable
            - ls android/app/src/main/res/drawable
        
            - npm install
            
            - echo "sdk.dir=$HOME/programs/android-sdk-macosx" > "$FCI_BUILD_DIR/android/local.properties"
            - echo $(jq .'build' build_data/data.json)
            - |
                if [[ $(jq -r .'build' build_data/data.json) == "android" ]] || [[ $(jq -r ."build" build_data/data.json) == "both" ]] ; then
                echo "block executed";
                # build Android;
                cd android;
                ./gradlew assembleRelease;
                fi
           
            - |
                if [[ $(jq -r ."build" build_data/data.json) == "ios" ]] || [[ $(jq -r ."build" build_data/data.json) == "both" ]] ; then
                # build iOS
                cd ios
                pod install
                ls
                xcodebuild -scheme "$XCODE_SCHEME" -workspace "$XCODE_WORKSPACE.xcworkspace" -configuration Release clean archive -archivePath "Build/APPNAME.xcarchive" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO         
                xcodebuild -exportArchive -archivePath build/APPNAME.xcarchive -exportOptionsPlist exportOptions.plist -exportPath build/APPNAME.ipa
                fi 
           
        artifacts:
          
             - android/app/build/outputs/**/*.apk
          
             - ios/Build/*.ipa 
             - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.ipa
        
           